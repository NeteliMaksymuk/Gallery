subdirs=['_HALL 16 - De Stijl', '_HALL 17 - Authurs du Bauhaus', '_HALL 18 - Supremacism and Constructivism',
         '04.05.64',"À quatre heures d'été, l'espoir", 'ABC', "Accès à l'été", 'Acrobate',
         'Aile de papillon', 'Akzent in Rosa', 'André Marfaing - Sans titre, 1963',
         'Auf Spitzen', 'Auf Weiss II', 'Avventuroso', 'Bauhauslampe',
         'Bewtiful & Stwong', 'Big Electric Chair', 'Bild mit rotem Fleck',
         'Black Cross (installation)', 'Black Square (installation)',
         'Black White', 'Bleu I', 'Bleu II', 'Bleu III', 'Bock syncopé n°I',
         'Bram van Velde - Sans Titre', 'Byzantinerin (Helle Lippen)', 'Chapeau de paille_',
         'Chaîne de mémoire III (EG 130)', 'Chizensei Konseimao', "Chopin's Waterloo",
         'Clown', 'Composition', 'Composition 1 t', 'Composition 3 z', 'Composition 5 x',
         'Composition A.XX', 'Composition No. 5', 'Composition n° 522',
         'Composition n°24', 'Composition spatiodynamique', 'Composition X',
         'Compression', 'Conférencier', "Conte de pistils et d'étamines n°I",
         'Cross', 'Crucifixion 12', 'Cuadro 120', 'Danse de Saint-Guy (Tabac-Rat)',
         'Dark Blue Panel', 'Der kleine Fisch', 'Dimanche', 'Disques de Newton. Etude pour Fugue à deux cou-leurs', 'Double portrait au verre de vin', 'Du jaune au violet', 'Erinnerungen an die Spiegelsäle von Brüssel', 'Étude pour Amorpha, Fugue à deux couleurs', 'Explosion lyrique n° 2', 'Explosion lyrique n°8', 'Femme douce', 'Femme déguisée', 'Femme nue dans une salle de bain', 'Figure 5', 'Florentinisches Villen Viertel', 'Formes circulaires, Soleil n° 2', 'Four Store Fronts Corner', 'Four Store Fronts Corner,', 'Frantisek Kupka', 'Fresh Widow', 'Grand palimpseste jaune', 'Grande Composition au corbeau', 'Green Relief', 'Grenade bleue', 'Gul kvinde ved havet', 'Il Ritornante', 'Improvisation 3', 'Improvisation XIV', 'In Advance of the Broken Arm', 'in den Dünen', 'Inferno Hallelujah', 'Jeune Finlandaise', 'Komposition (Aquarium)', "L'Accusé", "L'Addition", "L'Adorable Trixie", "L'Animal sorcier", "L'Apprenti ouvrier", "L'Estaque", "L'Hommage au donateur", "L'homme qui descend", "L'Homme à la charrette", "L'Écorché", 'La boule blanche', 'La Chambre turque', "La Chute d'Icare", 'La Conquête de la Franche-Comté par le mois de juin', 'La Douche', 'La Force pure III,', 'La Fusée noire', 'La Promenade', 'La Rue', 'La Seine au Pecq', 'La Toilette de Cathy', 'Lautenspielerin, 1910', 'Le Baiser', 'Le Calvaire', 'Le Cheval blanc', 'Le Cirque Médrano', 'Le Clown blessé', "Le Comte St-Genois d'Anneaucourt", 'Le Faubourg de Collioure', 'Le Gilet de Maïakovski', 'Le Grand Ramsès', 'Le magasin de Ben', 'Le marchand de journaux', 'Le Monstre de Soisy', 'Le Phare', 'Le Pot à tisane', 'Le Poète Philippe Soupault', 'Le Roman du rose n°1', 'Le Songe, dit aussi Suzanne et les vieillards', 'Le Voyageur sans boussole', 'Les arbres rouges', 'Les Boîtes', 'Les Chiffons de La Châtre - Corsets roses, printemps 1960', 'Les Correspondances', 'Les Coteaux de Rueil', 'Les Disques dans la ville', 'Les Mariés de la tour Eiffel', "Les Miroirs de l'Asie", 'Les Ouvriers sur la charrette', 'Les Quais de la Tamise', 'Les Toits', 'Les Tours de Laon', 'Liebesperlen', 'Lignes animées', 'Léda et le cygne', 'Manège de cochons', 'Mao à San Marco', 'Maxime aux bas verts', 'Meurtre n°20_1,', 'Michel Tapié soleil', 'Mit dem scharzen Bogen', 'Musique', 'Nefertari as Lautrec', 'Neuf Moules Mâlic', 'Nini, danseuse aux Folies-Bergères', 'Not There-Here', 'Nu de dos', 'N° 14 (Browns over Dark)', 'O Salvador', 'Objets usuels, pour Vincent Van Gogh_', 'Occhio di lucertola', 'Opus 15C', 'Ordonnance sur verticales en jaune', 'Où es-tu_ Que fais-tu_,', 'Parade (détail)', 'Passion', 'Paysan au parapluie', 'Peinture 131 × 162 cm', 'Peinture 200 x 220 cm', 'Peinture 260 x 202 cm', 'Peinture n° 530', 'Peinture, 220 × 366 cm', 'Personnage', 'Pierre n°31 sur fond bleu',
         'Plans verticaux I', "Portrait d'Alice Derain", "Portrait d'une danseuse", 'Portrait de Fernand Fleuret', 'Portrait de Guynemer', 'Portrait de Suzanne Duchamp', 'Portrait multiple de Francis Picabia', "PR1, Portrait-relief d'Arman", 'Pure Painting', 'Raumkonstruktion 3', 'Reciprocal Accords', 'Red Roofs', 'Relief carton', 'Relief spatiodynamique B', 'Rhythmisches', 'Roberte et les barres parallèles', 'Rythme', 'Sans titre II, Kardas, vers 1925-1930', 'Sans titre III, Kardas, vers1925-1930', 'Sans titre IV, Kardas, vers 1927-1929', 'Sans titre V, Kardas, vers 1925-1930', 'Sans titre, Kardas, vers 1925-1930',
         'Sans titre, Pevsner 1923', 'Sans titre, Pevsner, 1920', 'Sensation du danger', 'Sky Blue', 'Souffle de Mai 1968', 'Spatiodynamique 1', 'Spatiodynamique 22', 'Spatiodynamique 26 (dite _Gigogne_)', 'Spatiodynamique 8', 'Spatioplastique 6', 'Stilleben mit zwei Tänzerinnen', 'Store Front', 'Sérénité profuse', 'T 1956-14', 'Tableau métallique - portrait à géométrie convexe', 'The Bird Walker', 'The Moon', 'Tir', 'Toilette - Frau vor dem Spiegel', 'Totem Double face', 'Traits noirs enroulés', 'Traits, plans et profondeur 1', 'Traits, plans, espace IlI', 'Two Green Points', 'Tänzerin', 'Tête de turc', 'Udnie', 'Une Rue de Marly-le-Roi', 'Unknown Journey', 'Van Gogh in a landscape', 'Vragende Kinderen', "Vu d'ici", 'Weihnachtsengel mit Bethlehemszene, 2. Fassung', 'White Over Black III', 'Woman with Artificial Heart']


from tensorflow.keras.models import load_model
from tensorflow.keras.preprocessing.image import load_img, img_to_array
from tensorflow.keras.preprocessing.image import ImageDataGenerator
import numpy as np
import os

from flask import *
app = Flask(__name__, template_folder='templates',  static_folder='static')

def find_p(img):
    model = load_model('/dataset/test3.h5')
    image_path = img.filename
    image = load_img(image_path, target_size=(224, 224))

    image_array = img_to_array(image)
    image_array = np.expand_dims(image_array, axis=0)
    datagen = ImageDataGenerator()
    image_array = datagen.standardize(image_array)


    preds = model.predict(image_array)

    max_class_idx = np.argmax(preds)
    if max_class_idx >= 224:
        preds='Not found'
    else:
        preds = subdirs[max_class_idx]


    print("Клас з максимальною ймовірністю: ", preds,max_class_idx)
    return preds


@app.route('/', methods=['GET', 'POST'])
def main():
    return render_template('base.html')


@app.route('/upload', methods=['GET', 'POST'])
def upload_file():
    app.config['UPLOAD_FOLDER'] = '.'
    if request.method == 'POST':
        file = request.files['file']
        if file.filename == '':
            flash('No selected file')
            return 400
    filename = file.filename
    file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))
    print(filename)
    pic_text = find_p(file)
    os.remove(os.path.join(app.config['UPLOAD_FOLDER'], filename))
    return render_template('index.html', pic_text=pic_text)


if __name__ == '__main__':
    app.run()
